#!/usr/bin/env nix-shell
#! nix-shell -i bash -p sox whisper-cpp xsel mpv

# vtxt - Voice to text using sox and whisper

set -e

AUDIO_FILE="/tmp/vtxt-$(date +%s).wav"
MODEL="$HOME/.whisper/models/ggml-base.en.bin"

# Download model if it doesn't exist
if [[ ! -f "$MODEL" ]]; then
    echo "Downloading whisper model..."
    mkdir -p "$(dirname "$MODEL")"
    whisper-cpp-download-ggml-model base.en "$(dirname "$MODEL")"
fi

echo "Recording... Press Ctrl+C when done"
rec -r 16000 -c 1 "$AUDIO_FILE" silence 1 0.1 3% 1 2.0 3% 2>/dev/null
echo

if [[ -n "$DEBUG" ]]; then
    echo "Playing back..."
    mpv --no-terminal "$AUDIO_FILE"
fi

TEXT=$(whisper-cli -m "$MODEL" -f "$AUDIO_FILE" --no-timestamps -np 2>/dev/null | tr -d '\033' | sed 's/\[200~//;s/\[201~//;s/~$//' | awk '{$1=$1};1' | sed '/^$/d')

rm "$AUDIO_FILE"

echo "$TEXT"
echo -n "$TEXT" | xsel --clipboard --input
echo "Copied to clipboard"
