#!/usr/bin/env bash

if [ "$1" = "update" ]; then
    cd ~/src/github.com/sourcegraph/amp
    git pull
    eval "$(direnv export bash)"
    pnpm install
    cd cli
    pnpm build:production
else
    if [[ "$TERM" == tmux* ]]; then
        export FORCE_HYPERLINK=1
    fi

    if command -v bwrap >/dev/null 2>&1; then
        exec bwrap \
            --ro-bind / / \
            --bind "$PWD" "$PWD" \
            --bind ~/.amp ~/.amp \
            --bind ~/.config ~/.config \
            --bind ~/.cache ~/.cache \
            --bind ~/.local ~/.local \
            --dev /dev \
            --proc /proc \
            --tmpfs /tmp \
            node ~/src/github.com/sourcegraph/amp/cli/dist/main.js --dangerously-allow-all "$@"
    else
        exec node ~/src/github.com/sourcegraph/amp/cli/dist/main.js "$@"
    fi
fi
